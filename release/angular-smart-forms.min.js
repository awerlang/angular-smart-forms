// https://github.com/awerlang/angular-smart-forms
!function(){"use strict";function isItMobile(){return"ontouchstart"in document.documentElement&&window.innerWidth<768}function find(element,selector){return angular.element(element.map(function(index,item){return item.querySelector(selector)}))}function findNextTabStop(el,parent){var universe=(parent||document).querySelectorAll("input, button, select, textarea, a[href]"),list=Array.prototype.filter.call(universe,function(item){return item.tabIndex>="0"}),index=list.indexOf(el);return list[index+1]||list[0]}function tabToNext(currentElement,parent){var nextElement=findNextTabStop(currentElement);nextElement&&nextElement.focus()}function smartForm(){return{restrict:"A",link:function(scope,element,attrs){function tabOnMaxLength(event){var maxLength=event.target.maxLength;maxLength&&event.target.value.length===maxLength&&tabToNext(event.target,element[0])}function tabOnEnter(event){if(event.which===KEYS.RETURN){var el=event.target;switch(el.tagName){case"INPUT":if("submit"===el.type||"button"===el.type)return;case"SELECT":tabToNext(event.target,element[0]),event.preventDefault()}}}element.on("input",tabOnMaxLength),element.on("keydown",tabOnEnter)}}}function autoFocus(){return isItMobile()?{}:{restrict:"A",link:function(scope,element){function setFocus(selector){var firstElement=element[0].querySelector(selector);firstElement&&firstElement.focus()}function setFocusOnPartialLoaded(){setFocus(["input:not([disabled])","select:not([disabled])","fieldset:not([disabled]) input:not([disabled])","fieldset:not([disabled]) select:not([disabled])"].join(","))}function setFocusOnFormSubmit(){setFocus(".ng-invalid")}scope.$on("$viewContentLoaded",setFocusOnPartialLoaded),scope.$on("$includeContentLoaded",setFocusOnPartialLoaded),element.on("submit",setFocusOnFormSubmit)}}}function isoDate(){return{restrict:"A",require:"ngModel",link:function(scope,element,attrs,ngModelCtrl){ngModelCtrl.$parsers.push(function(value){return angular.isDate(value)?value.toISOString().substring(0,10)+"T00:00:00.000Z":value}),ngModelCtrl.$formatters.push(function(value){if(angular.isString(value)){var regex=/(\d{4})-(\d{2})-(\d{2})T?.*/,dateParts=regex.exec(value);if(dateParts)return new Date(parseInt(dateParts[1],10),parseInt(dateParts[2],10)-1,parseInt(dateParts[3],10))}return value})}}}function isoDateFilter($filter){var dateFilter=$filter("date");return function(date,format){return dateFilter(date,format||"shortDate","UTC")}}function numberInput(){return{restrict:"A",priority:1,require:"ngModel",link:function(scope,element,attrs,ngModelCtrl){element.attr("type","text"),ngModelCtrl.$parsers.unshift(function(value){return null==value?value:""===value.trim()?null:parseToModel(value)}),ngModelCtrl.$formatters.unshift(function(value){return null==value?value:formatWithThousandSep(value)}),element.on("focusout",function(e){var inputVal=element.val();""!==inputVal&&element.val(formatWithDecimalSep(inputVal))}),element.on("input",function(e){var inputVal=element.val(),res=formatOnInput(inputVal);ngModelCtrl.$viewValue!==res&&scope.$apply(function(){ngModelCtrl.$setViewValue(res),ngModelCtrl.$render()})})}}}function splice(intPart,idx,rem,s){return intPart.slice(0,idx)+s+intPart.slice(idx+Math.abs(rem))}function formatWithThousandSep(nStr){nStr+="";for(var x=nStr.split("."),x1=x[0],x2=x.length>1?","+x[1]:"",rgx=/(\d+)(\d{3})/;rgx.test(x1);)x1=x1.replace(rgx,"$1.$2");return x1+x2}function formatWithDecimalSep(value){var regex=/\,(\d*)/,result=regex.exec(value),decPart=2-(result?result[1].length:0);for(result&&null==result[0]&&(value="0"+value),null===result&&(value+=",");decPart-->0;)value+="0";return value}function parseToModel(value){return parseFloat(value.replace(/\./g,"").replace(",","."))}function formatOnInput(value){for(var inputVal=value;"0"===inputVal.charAt(0)&&","!==inputVal.charAt(0);)inputVal=inputVal.substr(1);","===inputVal.charAt(0)&&(inputVal="0"+inputVal),inputVal=inputVal.replace(/[^\d.\',']/g,"");var point=inputVal.indexOf(",");point>=0&&(inputVal=inputVal.slice(0,point+3));var decimalSplit=inputVal.split(","),intPart=decimalSplit[0],decPart=decimalSplit[1];if(intPart=intPart.replace(/[^\d]/g,""),intPart.length>3)for(var intDiv=Math.floor(intPart.length/3);intDiv>0;){var lastComma=intPart.indexOf(".");0>lastComma&&(lastComma=intPart.length),lastComma-3>0&&(intPart=splice(intPart,lastComma-3,0,".")),intDiv--}decPart=void 0===decPart?"":","+decPart;var res=intPart+decPart;return res}function numpadInput(){return{link:function(scope,element,attrs){var selector=element.attr("wt-numpad"),input=selector?find(element,selector):element;input.attr("type","number").addClass("wt-numpad"),input.on("keypress",function(event){switch(event.which){case KEYS.PLUS:case KEYS.COMMA:case KEYS.MINUS:case KEYS.DOT:event.preventDefault()}})}}}function modelIsError(){return{restrict:"A",require:"ngModel",link:function(scope,element,attrs,ngModelCtrl){ngModelCtrl.$validators.modelIsError=function(modelValue,viewValue){return modelValue!==!0}}}}var KEYS={RETURN:13,SPACE:32,PLUS:43,COMMA:44,MINUS:45,DOT:46};angular.module("wt.smart",[]).directive("wtAutoFocus",[autoFocus]).directive("wtSmartForm",[smartForm]).directive("wtIsoDate",[isoDate]).filter("wtIsoDate",["$filter",isoDateFilter]).directive("wtNumber",[numberInput]).directive("wtNumpad",[numpadInput]).directive("wtModelIsError",[modelIsError])}();